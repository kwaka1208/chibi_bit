# 自動ナンバリング
3台以上のmicro:bitに自動的に番号を振るプログラムを作ってみました（パッケージじゃなくてMakeCodeの標準ブロックで作ったユーザープログラムです）。使い方の手順は以下の通りです。[microbit-AutoNumbering.hex](microbit-AutoNumbering.hex)をダウンロードして、すべてのmicro:bitにインストールしてください。

## 操作方法
1. ホストにするmicro:bitをひとつ選んでAボタンを押す。これでそのmicro:bitがホストになります。ホストには番号が割り振られません（内部的には0になります）。
2. ホストmicro:bitのBボタンを押すと他のmicro:bitに番号が表示されます。番号が表示されない場合は、何度かBボタンを押してみてください。

## このプログラムの考え方
このプログラムでは、ホストからのコマンドに対してクライアントが応答することで、各クライアントに番号を割り付けるようになっています。

1. ホスト内にクライアントの「固有の名前」リストを管理するための配列を作成します。「固有の名前」とはmicro:bitの各個体に割り当てられた名前で、UUIDを短くしたものと思われます。「シリアル番号」というブロックがありますが、この情報を短くしたものが「固有の名前」になります。
2. ホストから"JOIN,1"をブロードキャストで送信する。
3. "JOIN,1"を受けとったクライアントは、自分にID割り振られていなければ、"「固有の名前」,1"を送ります。
4. "「固有の名前」,1"を受け取ったホストは、受け取った「固有の名前」が配列の中にあるかどうか確認し、すでにあれば配列番号に10を加算したものと受け取った固有の名前を送信します。配列の中になければ受け取った「固有の名前」を配列に追加して、同じく配列番号に10を加算したものと受け取った固有の名前を送信します。
5. 配列番号+10と「固有の名前」を受け取った各クライアントは、「固有の名前」が自分のものと同じかどうかを判断し、同じであれば受け取った数値を自分のIDとして変数に格納し、表示します。受け取った数値は「配列番号+10」なので10を引いて「配列番号」を取り出し各クライアントのIDとしています。

## 設計のポイント
通信で一度にやり取りできる情報は文字列ひとつと数値がひとつなので、それぞれの意味を整理して通信しています。

|文字列（name）|意味|
|:--|:--|
|JOIN|ホストからクライアントへの探索要求|
|上記以外|各クライアントの固有の名前|

|数値（value）|意味|
|:--|:--|
|0|ホストからクライアントへの探索要求|
|1|クライアントからホストへの登録要求|
|2〜9|未使用|
|10以上|各クライアントのID|

## 開発環境について
[micro:bitの開発環境](https://makecode.microbit.org/)にアクセスして、「プロジェクト」をクリックし「ファイルを読み込む」から.hexファイルをアップロードするとブロックのプログラム画面が表示されます。
